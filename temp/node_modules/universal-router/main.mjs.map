{"version":3,"file":"main.mjs","sources":["src/matchPath.js","src/matchRoute.js","src/resolveRoute.js","src/UniversalRouter.js"],"sourcesContent":["/**\n * Universal Router (https://www.kriasoft.com/universal-router/)\n *\n * Copyright © 2015-present Kriasoft, LLC. All rights reserved.\n *\n * This source code is licensed under the Apache 2.0 license found in the\n * LICENSE.txt file in the root directory of this source tree.\n */\n\nimport pathToRegexp from 'path-to-regexp';\n\nconst cache = new Map();\n\nfunction decodeParam(val) {\n  try {\n    return decodeURIComponent(val);\n  } catch (err) {\n    return val;\n  }\n}\n\nfunction parseParam(key, value) {\n  if (key.repeat) {\n    return value ? value.split(key.delimiter).map(decodeParam) : [];\n  }\n  return value ? decodeParam(value) : value;\n}\n\nfunction matchPath(route, path, parentKeys, parentParams) {\n  const key = `${route.path || ''}|${!route.children}`;\n  let regexp = cache.get(key);\n\n  if (!regexp) {\n    const keys = [];\n    regexp = {\n      keys,\n      pattern: pathToRegexp(route.path || '', keys, { end: !route.children }),\n    };\n    cache.set(key, regexp);\n  }\n\n  const m = regexp.pattern.exec(path);\n  if (!m) {\n    return null;\n  }\n\n  const params = Object.assign({}, parentParams);\n\n  for (let i = 1; i < m.length; i += 1) {\n    params[regexp.keys[i - 1].name] = parseParam(regexp.keys[i - 1], m[i]);\n  }\n\n  return {\n    path: m[0],\n    keys: regexp.keys.concat(parentKeys),\n    params,\n  };\n}\n\nexport default matchPath;\n","/**\n * Universal Router (https://www.kriasoft.com/universal-router/)\n *\n * Copyright © 2015-present Kriasoft, LLC. All rights reserved.\n *\n * This source code is licensed under the Apache 2.0 license found in the\n * LICENSE.txt file in the root directory of this source tree.\n */\n\nimport matchPath from './matchPath';\n\nfunction matchRoute(route, baseUrl, path, parentKeys, parentParams) {\n  let match;\n  let childMatches;\n  let childIndex = 0;\n\n  return {\n    next() {\n      if (!match) {\n        match = matchPath(route, path, parentKeys, parentParams);\n\n        if (match) {\n          return {\n            done: false,\n            value: {\n              route,\n              baseUrl,\n              path: match.path,\n              keys: match.keys,\n              params: match.params,\n            },\n          };\n        }\n      }\n\n      if (match && route.children) {\n        while (childIndex < route.children.length) {\n          if (!childMatches) {\n            const childRoute = route.children[childIndex];\n            childRoute.parent = route;\n\n            childMatches = matchRoute(\n              childRoute,\n              baseUrl + match.path,\n              path.substr(match.path.length),\n              match.keys,\n              match.params,\n            );\n          }\n\n          const childMatch = childMatches.next();\n          if (!childMatch.done) {\n            return {\n              done: false,\n              value: childMatch.value,\n            };\n          }\n\n          childMatches = null;\n          childIndex += 1;\n        }\n      }\n\n      return { done: true };\n    },\n  };\n}\n\nexport default matchRoute;\n","/**\n * Universal Router (https://www.kriasoft.com/universal-router/)\n *\n * Copyright © 2015-present Kriasoft, LLC. All rights reserved.\n *\n * This source code is licensed under the Apache 2.0 license found in the\n * LICENSE.txt file in the root directory of this source tree.\n */\n\nfunction resolveRoute(context, params) {\n  if (typeof context.route.action === 'function') {\n    return context.route.action(context, params);\n  }\n\n  return null;\n}\n\nexport default resolveRoute;\n","/**\n * Universal Router (https://www.kriasoft.com/universal-router/)\n *\n * Copyright © 2015-present Kriasoft, LLC. All rights reserved.\n *\n * This source code is licensed under the Apache 2.0 license found in the\n * LICENSE.txt file in the root directory of this source tree.\n */\n\nimport pathToRegexp from 'path-to-regexp';\nimport matchPath from './matchPath';\nimport matchRoute from './matchRoute';\nimport resolveRoute from './resolveRoute';\n\nfunction isChildRoute(parentRoute, childRoute) {\n  let route = childRoute;\n  while (route) {\n    route = route.parent;\n    if (route === parentRoute) {\n      return true;\n    }\n  }\n  return false;\n}\n\nclass UniversalRouter {\n  constructor(routes, options = {}) {\n    if (Object(routes) !== routes) {\n      throw new TypeError('Invalid routes');\n    }\n\n    this.baseUrl = options.baseUrl || '';\n    this.resolveRoute = options.resolveRoute || resolveRoute;\n    this.context = Object.assign({ router: this }, options.context);\n    this.root = Array.isArray(routes) ? { path: '', children: routes, parent: null } : routes;\n    this.root.parent = null;\n  }\n\n  resolve(pathnameOrContext) {\n    const context = Object.assign(\n      {},\n      this.context,\n      typeof pathnameOrContext === 'string' ? { pathname: pathnameOrContext } : pathnameOrContext,\n    );\n    const match = matchRoute(\n      this.root,\n      this.baseUrl,\n      context.pathname.substr(this.baseUrl.length),\n      [],\n      null,\n    );\n    const resolve = this.resolveRoute;\n    let matches = null;\n    let nextMatches = null;\n\n    function next(resume, parent = matches.value.route) {\n      matches = nextMatches || match.next();\n      nextMatches = null;\n\n      if (!resume) {\n        if (matches.done || !isChildRoute(parent, matches.value.route)) {\n          nextMatches = matches;\n          return Promise.resolve(null);\n        }\n      }\n\n      if (matches.done) {\n        return Promise.reject(Object.assign(\n          new Error('Page not found'),\n          { context, status: 404, statusCode: 404 },\n        ));\n      }\n\n      return Promise.resolve(resolve(\n        Object.assign({}, context, matches.value),\n        matches.value.params,\n      )).then((result) => {\n        if (result !== null && result !== undefined) {\n          return result;\n        }\n\n        return next(resume, parent);\n      });\n    }\n\n    context.next = next;\n\n    return next(true, this.root);\n  }\n}\n\nUniversalRouter.pathToRegexp = pathToRegexp;\nUniversalRouter.matchPath = matchPath;\nUniversalRouter.matchRoute = matchRoute;\nUniversalRouter.resolveRoute = resolveRoute;\n\nexport default UniversalRouter;\n"],"names":["cache","Map","decodeParam","val","decodeURIComponent","err","parseParam","key","value","repeat","split","delimiter","map","matchPath","route","path","parentKeys","parentParams","children","regexp","get","keys","pathToRegexp","end","set","m","pattern","exec","params","Object","assign","i","length","name","concat","matchRoute","baseUrl","match","childMatches","childIndex","childRoute","parent","substr","childMatch","next","done","resolveRoute","context","action","isChildRoute","parentRoute","UniversalRouter","routes","options","TypeError","router","root","Array","isArray","pathnameOrContext","pathname","resolve","matches","nextMatches","resume","Promise","reject","Error","status","statusCode","then","result","undefined"],"mappings":"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"}